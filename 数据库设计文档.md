# 订单系统数据库设计文档

## 目录
- [概述](#概述)
- [表结构设计](#表结构设计)
- [表关系说明](#表关系说明)
- [索引设计](#索引设计)
- [设计原则](#设计原则)
- [使用示例](#使用示例)

---

## 概述

本文档描述了订单系统的五个核心表的设计：
- **users（用户表）**：存储用户基本信息
- **addresses（地址表）**：存储用户收货地址
- **products（商品表）**：存储商品信息
- **orders（订单表）**：存储订单信息
- **order_items（订单商品明细表）**：存储订单中的商品明细

### 表关系图

```
users (用户表)
  │
  ├── 1:N ──> addresses (地址表)
  │
  └── 1:N ──> orders (订单表)
                │
                ├── N:1 ──> addresses (地址表)
                │
                └── 1:N ──> order_items (订单明细表)
                              │
                              └── N:1 ──> products (商品表)
```

---

## 表结构设计

### 1. users（用户表）

**表说明**：存储系统用户的基本信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | uint | PRIMARY KEY, AUTO_INCREMENT | 用户ID（代理键） |
| username | varchar(50) | UNIQUE, NOT NULL | 用户名（自然键） |
| phone | varchar(20) | UNIQUE | 手机号 |
| email | varchar(100) | UNIQUE | 邮箱 |
| password | varchar(255) | NOT NULL | 密码（加密存储） |
| nickname | varchar(50) | | 昵称 |
| avatar | varchar(255) | | 头像URL |
| status | tinyint | DEFAULT 1 | 状态（1:正常 0:禁用） |
| created_at | timestamp | AUTO CREATE | 创建时间 |
| updated_at | timestamp | AUTO UPDATE | 更新时间 |
| deleted_at | timestamp | SOFT DELETE | 删除时间（软删除） |

**设计要点**：
- ✅ 使用 `id` 作为主键（代理键），保证性能和稳定性
- ✅ `username`、`phone`、`email` 作为业务标识，建立唯一索引
- ✅ 使用软删除（`deleted_at`），保留历史数据
- ✅ `password` 字段在 JSON 序列化时隐藏（`json:"-"`）

**索引设计**：
- PRIMARY KEY: `id`
- UNIQUE INDEX: `username`
- UNIQUE INDEX: `phone`
- UNIQUE INDEX: `email`
- INDEX: `deleted_at`（软删除索引）

---

### 2. addresses（地址表）

**表说明**：存储用户的收货地址信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | uint | PRIMARY KEY, AUTO_INCREMENT | 地址ID（代理键） |
| user_id | uint | NOT NULL, INDEX, FOREIGN KEY | 用户ID（关联users.id） |
| receiver_name | varchar(50) | NOT NULL | 收货人姓名 |
| receiver_phone | varchar(20) | NOT NULL | 收货人电话 |
| province | varchar(50) | NOT NULL | 省份 |
| city | varchar(50) | NOT NULL | 城市 |
| district | varchar(50) | NOT NULL | 区/县 |
| detail | varchar(255) | NOT NULL | 详细地址 |
| postal_code | varchar(10) | | 邮政编码 |
| is_default | tinyint(1) | DEFAULT 0 | 是否默认地址（1:是 0:否） |
| created_at | timestamp | AUTO CREATE | 创建时间 |
| updated_at | timestamp | AUTO UPDATE | 更新时间 |
| deleted_at | timestamp | SOFT DELETE | 删除时间（软删除） |

**设计要点**：
- ✅ 一个用户可以有多个地址（一对多关系）
- ✅ 地址信息拆分到省、市、区、详细地址，便于查询和统计
- ✅ `is_default` 字段标识默认地址
- ✅ 收货人信息独立存储，允许与用户信息不同

**索引设计**：
- PRIMARY KEY: `id`
- INDEX: `user_id`（外键索引）
- INDEX: `deleted_at`（软删除索引）

**外键约束**：
- FOREIGN KEY (`user_id`) REFERENCES `users`(`id`)

---

### 3. orders（订单表）

**表说明**：存储订单信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | uint | PRIMARY KEY, AUTO_INCREMENT | 订单ID（代理键） |
| order_no | varchar(32) | UNIQUE, NOT NULL | 订单号（自然键） |
| user_id | uint | NOT NULL, INDEX, FOREIGN KEY | 用户ID（关联users.id） |
| address_id | uint | NOT NULL, INDEX, FOREIGN KEY | 收货地址ID（关联addresses.id） |
| total_amount | decimal(10,2) | NOT NULL, DEFAULT 0.00 | 订单总金额 |
| discount_amount | decimal(10,2) | DEFAULT 0.00 | 优惠金额 |
| pay_amount | decimal(10,2) | NOT NULL, DEFAULT 0.00 | 实付金额 |
| status | tinyint | DEFAULT 0, INDEX | 订单状态（0:待支付 1:已支付 2:已发货 3:已完成 4:已取消） |
| pay_method | varchar(20) | | 支付方式 |
| pay_time | timestamp | | 支付时间 |
| ship_time | timestamp | | 发货时间 |
| complete_time | timestamp | | 完成时间 |
| remark | varchar(500) | | 订单备注 |
| created_at | timestamp | AUTO CREATE | 创建时间 |
| updated_at | timestamp | AUTO UPDATE | 更新时间 |
| deleted_at | timestamp | SOFT DELETE | 删除时间（软删除） |

**设计要点**：
- ✅ 使用 `id` 作为主键（代理键）
- ✅ `order_no` 作为业务标识，建立唯一索引
- ✅ 金额字段使用 `decimal(10,2)` 类型，保证精度
- ✅ 订单状态使用枚举值，便于查询和统计
- ✅ 记录关键时间节点（支付、发货、完成）

**订单状态说明**：
- `0` - 待支付：订单已创建，等待支付
- `1` - 已支付：订单已支付，等待发货
- `2` - 已发货：订单已发货，等待收货
- `3` - 已完成：订单已完成
- `4` - 已取消：订单已取消

**索引设计**：
- PRIMARY KEY: `id`
- UNIQUE INDEX: `order_no`
- INDEX: `user_id`（外键索引）
- INDEX: `address_id`（外键索引）
- INDEX: `status`（状态索引，便于查询）
- INDEX: `deleted_at`（软删除索引）

**外键约束**：
- FOREIGN KEY (`user_id`) REFERENCES `users`(`id`)
- FOREIGN KEY (`address_id`) REFERENCES `addresses`(`id`)

---

### 4. products（商品表）

**表说明**：存储商品信息

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | uint | PRIMARY KEY, AUTO_INCREMENT | 商品ID（代理键） |
| product_no | varchar(50) | UNIQUE, NOT NULL | 商品编号（自然键） |
| name | varchar(200) | NOT NULL, INDEX | 商品名称 |
| description | text | | 商品描述 |
| category_id | uint | INDEX | 分类ID |
| price | decimal(10,2) | NOT NULL, DEFAULT 0.00 | 商品价格 |
| stock | int | DEFAULT 0 | 库存数量 |
| sales | int | DEFAULT 0 | 销量 |
| image | varchar(500) | | 商品主图 |
| images | text | | 商品图片(JSON数组) |
| status | tinyint | DEFAULT 1, INDEX | 状态（1:上架 0:下架） |
| sort | int | DEFAULT 0 | 排序 |
| created_at | timestamp | AUTO CREATE | 创建时间 |
| updated_at | timestamp | AUTO UPDATE | 更新时间 |
| deleted_at | timestamp | SOFT DELETE | 删除时间（软删除） |

**设计要点**：
- ✅ 使用 `id` 作为主键（代理键）
- ✅ `product_no` 作为业务标识，建立唯一索引
- ✅ 价格使用 `decimal(10,2)` 类型，保证精度
- ✅ 库存和销量字段，便于库存管理和统计
- ✅ 商品信息快照：订单明细表中保存商品快照，避免商品信息变更影响历史订单

**商品状态说明**：
- `1` - 上架：商品正常销售
- `0` - 下架：商品暂时下架

**索引设计**：
- PRIMARY KEY: `id`
- UNIQUE INDEX: `product_no`
- INDEX: `name`（商品名称索引，便于搜索）
- INDEX: `category_id`（分类索引）
- INDEX: `status`（状态索引，便于查询）
- INDEX: `deleted_at`（软删除索引）

---

### 5. order_items（订单商品明细表）

**表说明**：存储订单中的商品明细信息（订单和商品的多对多关系中间表）

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | uint | PRIMARY KEY, AUTO_INCREMENT | 明细ID（代理键） |
| order_id | uint | NOT NULL, INDEX, FOREIGN KEY | 订单ID（关联orders.id） |
| product_id | uint | NOT NULL, INDEX, FOREIGN KEY | 商品ID（关联products.id） |
| product_name | varchar(200) | NOT NULL | 商品名称（快照） |
| product_image | varchar(500) | | 商品图片（快照） |
| price | decimal(10,2) | NOT NULL | 商品单价（快照） |
| quantity | int | NOT NULL, DEFAULT 1 | 购买数量 |
| subtotal | decimal(10,2) | NOT NULL | 小计金额 |
| created_at | timestamp | AUTO CREATE | 创建时间 |
| updated_at | timestamp | AUTO UPDATE | 更新时间 |
| deleted_at | timestamp | SOFT DELETE | 删除时间（软删除） |

**设计要点**：
- ✅ 订单和商品的多对多关系通过中间表实现
- ✅ **商品信息快照**：保存下单时的商品信息（名称、图片、价格），避免商品信息变更影响历史订单
- ✅ `subtotal = price * quantity`：小计金额 = 单价 × 数量
- ✅ 一个订单可以包含多个商品，一个商品可以出现在多个订单中

**索引设计**：
- PRIMARY KEY: `id`
- INDEX: `order_id`（外键索引）
- INDEX: `product_id`（外键索引）
- INDEX: `deleted_at`（软删除索引）

**外键约束**：
- FOREIGN KEY (`order_id`) REFERENCES `orders`(`id`)
- FOREIGN KEY (`product_id`) REFERENCES `products`(`id`)

---

## 表关系说明

### 1. users ↔ addresses（一对多）

**关系**：一个用户可以有多个收货地址

**实现**：
```go
// User 结构体
type User struct {
    Addresses []Address `gorm:"foreignKey:UserID;references:ID"`
}

// Address 结构体
type Address struct {
    UserID uint
    User   User `gorm:"foreignKey:UserID;references:ID"`
}
```

**查询示例**：
```go
// 查询用户的所有地址
var user User
db.Preload("Addresses").First(&user, 1)

// 查询地址所属用户
var address Address
db.Preload("User").First(&address, 1)
```

### 2. users ↔ orders（一对多）

**关系**：一个用户可以有多个订单

**实现**：
```go
// User 结构体
type User struct {
    Orders []Order `gorm:"foreignKey:UserID;references:ID"`
}

// Order 结构体
type Order struct {
    UserID uint
    User   User `gorm:"foreignKey:UserID;references:ID"`
}
```

**查询示例**：
```go
// 查询用户的所有订单
var user User
db.Preload("Orders").First(&user, 1)

// 查询订单所属用户
var order Order
db.Preload("User").First(&order, 1)
```

### 3. addresses ↔ orders（一对多）

**关系**：一个地址可以被多个订单使用（历史订单）

**实现**：
```go
// Address 结构体
type Address struct {
    Orders []Order `gorm:"foreignKey:AddressID;references:ID"`
}

// Order 结构体
type Order struct {
    AddressID uint
    Address   Address `gorm:"foreignKey:AddressID;references:ID"`
}
```

**查询示例**：
```go
// 查询地址的所有订单
var address Address
db.Preload("Orders").First(&address, 1)

// 查询订单的收货地址
var order Order
db.Preload("Address").First(&order, 1)
```

### 4. orders ↔ order_items（一对多）

**关系**：一个订单可以包含多个商品明细

**实现**：
```go
// Order 结构体
type Order struct {
    OrderItems []OrderItem `gorm:"foreignKey:OrderID;references:ID"`
}

// OrderItem 结构体
type OrderItem struct {
    OrderID uint
    Order   Order `gorm:"foreignKey:OrderID;references:ID"`
}
```

**查询示例**：
```go
// 查询订单的所有商品明细
var order Order
db.Preload("OrderItems").First(&order, 1)

// 查询明细所属订单
var orderItem OrderItem
db.Preload("Order").First(&orderItem, 1)
```

### 5. products ↔ order_items（一对多）

**关系**：一个商品可以出现在多个订单明细中

**实现**：
```go
// Product 结构体
type Product struct {
    OrderItems []OrderItem `gorm:"foreignKey:ProductID;references:ID"`
}

// OrderItem 结构体
type OrderItem struct {
    ProductID uint
    Product   Product `gorm:"foreignKey:ProductID;references:ID"`
}
```

**查询示例**：
```go
// 查询商品的所有订单明细
var product Product
db.Preload("OrderItems").First(&product, 1)

// 查询明细对应的商品
var orderItem OrderItem
db.Preload("Product").First(&orderItem, 1)
```

### 6. orders ↔ products（多对多）

**关系**：通过 `order_items` 中间表实现，一个订单可以包含多个商品，一个商品可以出现在多个订单中

**查询示例**：
```go
// 查询订单的所有商品（通过中间表）
var order Order
db.Preload("OrderItems.Product").First(&order, 1)

// 查询商品的所有订单（通过中间表）
var product Product
db.Preload("OrderItems.Order").First(&product, 1)
```

---

## 索引设计

### 主键索引（PRIMARY KEY）
- `users.id`
- `addresses.id`
- `orders.id`

### 唯一索引（UNIQUE INDEX）
- `users.username`
- `users.phone`
- `users.email`
- `orders.order_no`

### 普通索引（INDEX）
- `addresses.user_id`（外键索引）
- `orders.user_id`（外键索引）
- `orders.address_id`（外键索引）
- `orders.status`（状态查询索引）
- 所有表的 `deleted_at`（软删除索引）

### 索引设计原则
1. ✅ **主键自动建立索引**：保证唯一性和查询性能
2. ✅ **外键字段建立索引**：提高关联查询性能
3. ✅ **唯一字段建立唯一索引**：保证数据唯一性
4. ✅ **常用查询字段建立索引**：如订单状态
5. ✅ **软删除字段建立索引**：提高软删除查询性能

---

## 设计原则

### 1. 遵循三范式

**第一范式（1NF）**：
- ✅ 所有字段都是原子值
- ✅ 地址信息拆分到省、市、区、详细地址

**第二范式（2NF）**：
- ✅ 非主键字段完全依赖于主键
- ✅ 地址信息独立成表，避免冗余

**第三范式（3NF）**：
- ✅ 消除传递依赖
- ✅ 订单地址通过外键关联，不冗余存储

### 2. 代理键 + 自然键

- ✅ **主键使用代理键（ID）**：保证性能和稳定性
- ✅ **业务标识使用自然键**：如 `username`、`order_no`
- ✅ **建立唯一索引**：保证业务标识的唯一性

### 3. 软删除

- ✅ 所有表都使用 `deleted_at` 字段实现软删除
- ✅ 保留历史数据，便于数据恢复和审计
- ✅ 查询时自动过滤已删除数据

### 4. 时间戳管理

- ✅ `created_at`：自动记录创建时间
- ✅ `updated_at`：自动更新修改时间
- ✅ `deleted_at`：记录删除时间（软删除）

### 5. 金额精度

- ✅ 使用 `decimal(10,2)` 类型存储金额
- ✅ 保证金额计算的精度
- ✅ 避免浮点数精度问题

---

## 使用示例

### 1. 创建用户

```go
user := User{
    Username: "zhangsan",
    Phone:    "13800138000",
    Email:    "zhangsan@example.com",
    Password: "hashed_password",
    Nickname: "张三",
    Status:   UserStatusNormal,
}
db.Create(&user)
```

### 2. 添加收货地址

```go
address := Address{
    UserID:       1,
    ReceiverName: "张三",
    ReceiverPhone: "13800138000",
    Province:     "广东省",
    City:         "深圳市",
    District:     "南山区",
    Detail:       "科技园南区",
    IsDefault:    true,
}
db.Create(&address)
```

### 3. 创建商品

```go
product := Product{
    ProductNo:   generateProductNo(),
    Name:        "iPhone 15 Pro",
    Description: "苹果最新款手机",
    CategoryID:  1,
    Price:       7999.00,
    Stock:       100,
    Image:       "https://example.com/iphone15.jpg",
    Status:      ProductStatusOnSale,
}
db.Create(&product)
```

### 4. 创建订单（包含商品明细）

```go
// 先创建订单
order := Order{
    OrderNo:       generateOrderNo(),
    UserID:        1,
    AddressID:     1,
    TotalAmount:   15998.00,
    DiscountAmount: 0.00,
    PayAmount:     15998.00,
    Status:        OrderStatusPending,
}
db.Create(&order)

// 创建订单明细
orderItems := []OrderItem{
    {
        OrderID:      order.ID,
        ProductID:    1,
        ProductName:  "iPhone 15 Pro",
        ProductImage: "https://example.com/iphone15.jpg",
        Price:        7999.00,
        Quantity:     2,
        Subtotal:     15998.00,
    },
}
db.Create(&orderItems)

// 更新订单总金额（如果需要）
db.Model(&order).Update("total_amount", 15998.00)
db.Model(&order).Update("pay_amount", 15998.00)
```

### 5. 查询用户订单（包含地址和商品明细信息）

```go
var orders []Order
db.Preload("User").Preload("Address").Where("user_id = ?", 1).Find(&orders)
```

### 6. 查询用户的默认地址

```go
var address Address
db.Where("user_id = ? AND is_default = ?", 1, true).First(&address)
```

### 7. 查询订单详情（包含商品明细）

```go
var order Order
db.Preload("User").
   Preload("Address").
   Preload("OrderItems").
   Preload("OrderItems.Product").
   First(&order, 1)
```

### 8. 查询商品的所有订单

```go
var product Product
db.Preload("OrderItems.Order").
   Preload("OrderItems.Order.User").
   First(&product, 1)
```

### 9. 更新订单状态

```go
now := time.Now()
db.Model(&Order{}).Where("id = ?", 1).Updates(Order{
    Status:      OrderStatusPaid,
    PayTime:     &now,
    PayMethod:   "微信支付",
})
```

### 10. 更新商品库存和销量

```go
// 下单时减少库存，增加销量
db.Model(&Product{}).
   Where("id = ?", 1).
   Updates(map[string]interface{}{
       "stock": gorm.Expr("stock - ?", 2),
       "sales": gorm.Expr("sales + ?", 2),
   })
```

### 11. 软删除订单

```go
db.Delete(&Order{}, 1)  // GORM 自动设置 deleted_at
```

### 12. 查询未删除的订单

```go
var orders []Order
db.Where("status = ?", OrderStatusPending).Find(&orders)  // 自动过滤已删除
```

---

## SQL 建表语句

如果需要手动创建表，可以使用以下 SQL：

```sql
-- 用户表
CREATE TABLE `users` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` varchar(50) NOT NULL COMMENT '用户名',
  `phone` varchar(20) DEFAULT NULL COMMENT '手机号',
  `email` varchar(100) DEFAULT NULL COMMENT '邮箱',
  `password` varchar(255) NOT NULL COMMENT '密码(加密)',
  `nickname` varchar(50) DEFAULT NULL COMMENT '昵称',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像URL',
  `status` tinyint DEFAULT '1' COMMENT '状态(1:正常 0:禁用)',
  `created_at` timestamp NULL DEFAULT NULL COMMENT '创建时间',
  `updated_at` timestamp NULL DEFAULT NULL COMMENT '更新时间',
  `deleted_at` timestamp NULL DEFAULT NULL COMMENT '删除时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_users_username` (`username`),
  UNIQUE KEY `idx_users_phone` (`phone`),
  UNIQUE KEY `idx_users_email` (`email`),
  KEY `idx_users_deleted_at` (`deleted_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';

-- 地址表
CREATE TABLE `addresses` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '地址ID',
  `user_id` int unsigned NOT NULL COMMENT '用户ID',
  `receiver_name` varchar(50) NOT NULL COMMENT '收货人姓名',
  `receiver_phone` varchar(20) NOT NULL COMMENT '收货人电话',
  `province` varchar(50) NOT NULL COMMENT '省份',
  `city` varchar(50) NOT NULL COMMENT '城市',
  `district` varchar(50) NOT NULL COMMENT '区/县',
  `detail` varchar(255) NOT NULL COMMENT '详细地址',
  `postal_code` varchar(10) DEFAULT NULL COMMENT '邮政编码',
  `is_default` tinyint(1) DEFAULT '0' COMMENT '是否默认地址(1:是 0:否)',
  `created_at` timestamp NULL DEFAULT NULL COMMENT '创建时间',
  `updated_at` timestamp NULL DEFAULT NULL COMMENT '更新时间',
  `deleted_at` timestamp NULL DEFAULT NULL COMMENT '删除时间',
  PRIMARY KEY (`id`),
  KEY `idx_addresses_user_id` (`user_id`),
  KEY `idx_addresses_deleted_at` (`deleted_at`),
  CONSTRAINT `fk_addresses_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='地址表';

-- 订单表
CREATE TABLE `orders` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '订单ID',
  `order_no` varchar(32) NOT NULL COMMENT '订单号',
  `user_id` int unsigned NOT NULL COMMENT '用户ID',
  `address_id` int unsigned NOT NULL COMMENT '收货地址ID',
  `total_amount` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '订单总金额',
  `discount_amount` decimal(10,2) DEFAULT '0.00' COMMENT '优惠金额',
  `pay_amount` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '实付金额',
  `status` tinyint DEFAULT '0' COMMENT '订单状态(0:待支付 1:已支付 2:已发货 3:已完成 4:已取消)',
  `pay_method` varchar(20) DEFAULT NULL COMMENT '支付方式',
  `pay_time` timestamp NULL DEFAULT NULL COMMENT '支付时间',
  `ship_time` timestamp NULL DEFAULT NULL COMMENT '发货时间',
  `complete_time` timestamp NULL DEFAULT NULL COMMENT '完成时间',
  `remark` varchar(500) DEFAULT NULL COMMENT '订单备注',
  `created_at` timestamp NULL DEFAULT NULL COMMENT '创建时间',
  `updated_at` timestamp NULL DEFAULT NULL COMMENT '更新时间',
  `deleted_at` timestamp NULL DEFAULT NULL COMMENT '删除时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_orders_order_no` (`order_no`),
  KEY `idx_orders_user_id` (`user_id`),
  KEY `idx_orders_address_id` (`address_id`),
  KEY `idx_orders_status` (`status`),
  KEY `idx_orders_deleted_at` (`deleted_at`),
  CONSTRAINT `fk_orders_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`),
  CONSTRAINT `fk_orders_address` FOREIGN KEY (`address_id`) REFERENCES `addresses` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单表';

-- 商品表
CREATE TABLE `products` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '商品ID',
  `product_no` varchar(50) NOT NULL COMMENT '商品编号',
  `name` varchar(200) NOT NULL COMMENT '商品名称',
  `description` text COMMENT '商品描述',
  `category_id` int unsigned DEFAULT NULL COMMENT '分类ID',
  `price` decimal(10,2) NOT NULL DEFAULT '0.00' COMMENT '商品价格',
  `stock` int DEFAULT '0' COMMENT '库存数量',
  `sales` int DEFAULT '0' COMMENT '销量',
  `image` varchar(500) DEFAULT NULL COMMENT '商品主图',
  `images` text COMMENT '商品图片(JSON数组)',
  `status` tinyint DEFAULT '1' COMMENT '状态(1:上架 0:下架)',
  `sort` int DEFAULT '0' COMMENT '排序',
  `created_at` timestamp NULL DEFAULT NULL COMMENT '创建时间',
  `updated_at` timestamp NULL DEFAULT NULL COMMENT '更新时间',
  `deleted_at` timestamp NULL DEFAULT NULL COMMENT '删除时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_products_product_no` (`product_no`),
  KEY `idx_products_name` (`name`),
  KEY `idx_products_category_id` (`category_id`),
  KEY `idx_products_status` (`status`),
  KEY `idx_products_deleted_at` (`deleted_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='商品表';

-- 订单商品明细表
CREATE TABLE `order_items` (
  `id` int unsigned NOT NULL AUTO_INCREMENT COMMENT '明细ID',
  `order_id` int unsigned NOT NULL COMMENT '订单ID',
  `product_id` int unsigned NOT NULL COMMENT '商品ID',
  `product_name` varchar(200) NOT NULL COMMENT '商品名称(快照)',
  `product_image` varchar(500) DEFAULT NULL COMMENT '商品图片(快照)',
  `price` decimal(10,2) NOT NULL COMMENT '商品单价(快照)',
  `quantity` int NOT NULL DEFAULT '1' COMMENT '购买数量',
  `subtotal` decimal(10,2) NOT NULL COMMENT '小计金额',
  `created_at` timestamp NULL DEFAULT NULL COMMENT '创建时间',
  `updated_at` timestamp NULL DEFAULT NULL COMMENT '更新时间',
  `deleted_at` timestamp NULL DEFAULT NULL COMMENT '删除时间',
  PRIMARY KEY (`id`),
  KEY `idx_order_items_order_id` (`order_id`),
  KEY `idx_order_items_product_id` (`product_id`),
  KEY `idx_order_items_deleted_at` (`deleted_at`),
  CONSTRAINT `fk_order_items_order` FOREIGN KEY (`order_id`) REFERENCES `orders` (`id`),
  CONSTRAINT `fk_order_items_product` FOREIGN KEY (`product_id`) REFERENCES `products` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单商品明细表';
```

---

## 总结

### 设计亮点

1. ✅ **遵循三范式**：减少数据冗余，提高数据一致性
2. ✅ **代理键 + 自然键**：兼顾性能和用户体验
3. ✅ **软删除机制**：保留历史数据，便于恢复和审计
4. ✅ **完善的索引设计**：提高查询性能
5. ✅ **合理的关系设计**：表间关联清晰，便于查询和维护
6. ✅ **金额精度保证**：使用 decimal 类型，避免精度问题

### 扩展建议

1. **商品分类表**：如果需要商品分类管理，可以创建 `categories` 表
2. **购物车表**：如果需要购物车功能，可以创建 `cart_items` 表
3. **支付记录表**：如果需要详细的支付记录，可以创建 `payments` 表
4. **物流信息表**：如果需要详细的物流跟踪，可以创建 `logistics` 表
5. **优惠券表**：如果需要优惠券功能，可以创建 `coupons` 表
6. **商品评价表**：如果需要商品评价功能，可以创建 `reviews` 表

---

*最后更新时间：2025年*

